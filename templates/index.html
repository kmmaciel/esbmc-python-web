<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESBMC-Python Checker</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>üîç</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">

<div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-[98%]">
  <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîç ESBMC-Python Checker</h1>

  <form id="verificarForm" class="space-y-6">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo Python:</label>
      <textarea id="codigo" rows="8" placeholder="# Cole seu c√≥digo Python aqui..."
        class="w-full border border-gray-300 rounded-lg p-3 font-mono text-sm resize-y focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
    </div>

    <div class="flex items-center justify-between gap-4">
      <span class="text-gray-500 text-sm">ou</span>
      <input type="file" id="arquivo" accept=".py"
        class="block w-full text-sm border border-gray-300 rounded-lg p-2 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Flags de Verifica√ß√£o:</label>
      <div class="grid sm:grid-cols-2 gap-3">

        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
          <input type="checkbox" id="check-unwind" class="accent-blue-600" checked>
          <label for="check-unwind" class="flex-1 text-sm">--unwind (passos)</label>
          <input type="number" id="unwind-value" value="32" min="1" class="w-20 border border-gray-300 rounded p-1 text-sm">
        </div>

        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
          <input type="checkbox" id="check-context-bound" class="accent-blue-600" checked>
          <label for="check-context-bound" class="flex-1 text-sm">--context-bound (threads)</label>
          <input type="number" id="context-value" value="2" min="1" class="w-20 border border-gray-300 rounded p-1 text-sm">
        </div>
        
        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
           <input type="checkbox" class="accent-blue-600 flag" value="--multi-property" id="multi-property" checked>
           <label for="multi-property" class="text-sm">--multi-property</label>
        </div>

        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
            <input type="checkbox" class="accent-blue-600 flag" value="--strict-types" id="strict-types">
            <label for="strict-types" class="text-sm">--strict-types</label>
         </div>

        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
          <input type="checkbox" class="accent-blue-600 flag" value="--memory-leak-check" id="memory-leak-check">
          <label for="memory-leak-check" class="text-sm">--memory-leak-check</label>
        </div>
        
        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
            <input type="checkbox" class="accent-blue-600 flag" value="--overflow-check" id="overflow-check">
            <label for="overflow-check" class="text-sm">--overflow-check</label>
          </div>

      </div>
    </div>

    <button id="submitButton" type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
      ‚ñ∂Ô∏è Executar Verifica√ß√£o
    </button>
  </form>

  <div id="resultadoContainer" class="mt-8 hidden">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">Resultado da Verifica√ß√£o:</h2>
    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
      <p><strong>Comando executado:</strong></p>
      <pre id="comando" class="bg-gray-100 p-2 rounded-lg text-sm mb-2 overflow-x-auto text-gray-600"></pre>

      <p><strong>Status:</strong> <span id="interpretacao-status" class="whitespace-pre-line"></span></p>
      <p><strong>Causa prov√°vel:</strong> <span id="interpretacao-causa" class="text-red-600 font-semibold whitespace-pre-line"></span></p>

      <button id="toggleConsole" class="mt-3 text-blue-600 text-sm hover:underline">Exibir sa√≠da completa do ESBMC</button>
      <pre id="saidaBruta" class="hidden bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto max-h-96 mt-3 font-mono"></pre>
    </div>
  </div>

  <div id="contraExemploContainer" class="mt-8 hidden">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">üîç Contraexemplo (Passo a Passo)</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h3 class="text-xs uppercase text-gray-500 font-bold mb-1">Execu√ß√£o do C√≥digo</h3>
        <div id="passoCodigo" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-y-auto h-96 font-mono leading-relaxed whitespace-pre"></div>
      </div>
      <div>
        <h3 class="text-xs uppercase text-gray-500 font-bold mb-1">Valores das Vari√°veis (Estado Atual)</h3>
        <pre id="passoVariaveis" class="bg-blue-50 text-blue-900 border border-blue-200 p-4 rounded-lg text-sm overflow-x-auto h-96 font-mono"></pre>
      </div>
    </div>

    <div class="flex justify-between items-center mt-3">
      <div class="flex gap-2 items-center">
        <button id="btnAnterior" class="bg-gray-200 text-gray-700 py-1 px-3 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">‚¨ÖÔ∏è Anterior</button>
        <button id="btnPlay" class="bg-blue-600 text-white py-1 px-4 rounded hover:bg-blue-700 disabled:opacity-50 font-bold">‚ñ∂ Play</button>
        <button id="btnProximo" class="bg-gray-200 text-gray-700 py-1 px-3 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Pr√≥ximo ‚û°Ô∏è</button>
      </div>
      <div class="text-right text-sm text-gray-700 flex items-center gap-2">
        <span>Velocidade:</span>
        <input type="number" id="velocidade" value="1000" min="100" step="100" class="w-20 border border-gray-300 rounded p-1 text-center"> ms
      </div>
    </div>

    <p id="indicadorPasso" class="text-sm text-gray-600 mt-2 text-center font-semibold"></p>
  </div>

  <div id="pytestContainer" class="mt-8 hidden">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">üß™ Teste de Regress√£o (Pytest)</h2>
    <p class="text-sm text-gray-600 mb-2">O sistema gerou um teste para reproduzir o comportamento verificado.</p>
    
    <div class="space-y-4">
        <div>
            <h3 class="text-xs uppercase text-gray-500 font-bold mb-1">C√≥digo do Teste Gerado</h3>
            <pre id="pytestCode" class="bg-gray-800 text-yellow-300 p-4 rounded-lg text-sm overflow-x-auto max-h-64 w-full font-mono"></pre>
        </div>
        <div>
            <h3 class="text-xs uppercase text-gray-500 font-bold mb-1">Resultado da Execu√ß√£o do Teste</h3>
            <pre id="pytestResult" class="bg-white text-gray-900 border border-gray-300 p-4 rounded-lg text-sm overflow-x-auto max-h-64 w-full font-mono"></pre>
        </div>
    </div>
  </div>
</div>

<script>
let contraexemplo = [];
let passoIndex = 0;
let intervaloPlay = null;

function renderizarPasso() {
  if (contraexemplo.length === 0) return;
  
  const passo = contraexemplo[passoIndex];
  if (!passo || !passo.codigo) return;

  const linhasCodigo = passo.codigo.split("\n");
  
  const htmlCodigo = linhasCodigo.map((line, idx) => {
    const num = idx + 1;
    
    if (num === passo.linha_atual) {
        const icone = passo.erro ? "‚ùå" : "‚û°Ô∏è";
        return `<div id="linha-focada" class="bg-gray-800 font-bold block"><span class="inline-block w-6 text-center select-none text-white">${icone}</span><span class="opacity-50 inline-block text-right mr-2 select-none w-6">${num}</span><span>${line}</span></div>`;
    } else {
        return `<div class="opacity-70 block"><span class="inline-block w-6 select-none">&nbsp;</span><span class="opacity-50 inline-block text-right mr-2 select-none w-6">${num}</span><span>${line}</span></div>`;
    }
  }).join(""); 
  
  const container = document.getElementById("passoCodigo");
  container.innerHTML = htmlCodigo;

  let varsTexto = "";
  if (Object.keys(passo.variaveis).length === 0) {
      varsTexto = "// Nenhuma vari√°vel monitorada neste passo.";
  } else {
      Object.keys(passo.variaveis).sort().forEach(key => {
          varsTexto += `${key} = ${passo.variaveis[key]}\n`;
      });
  }
  document.getElementById("passoVariaveis").textContent = varsTexto;

  document.getElementById("indicadorPasso").textContent = `Passo ${passoIndex + 1} de ${contraexemplo.length}`;
  document.getElementById("btnAnterior").disabled = passoIndex === 0;
  document.getElementById("btnProximo").disabled = passoIndex === contraexemplo.length - 1;
}

document.getElementById("btnAnterior").addEventListener("click", () => { 
    if(passoIndex > 0) { passoIndex--; renderizarPasso(); }
});

document.getElementById("btnProximo").addEventListener("click", () => { 
    if(passoIndex < contraexemplo.length - 1) { passoIndex++; renderizarPasso(); }
});

document.getElementById("btnPlay").addEventListener("click", () => {
  const btn = document.getElementById("btnPlay");
  if (intervaloPlay) {
    clearInterval(intervaloPlay);
    intervaloPlay = null;
    btn.textContent = "‚ñ∂ Play";
    btn.classList.remove("bg-red-600", "hover:bg-red-700");
    btn.classList.add("bg-blue-600", "hover:bg-blue-700");
  } else {
    const vel = parseInt(document.getElementById("velocidade").value) || 1000;
    btn.textContent = "‚è∏ Pause";
    btn.classList.remove("bg-blue-600", "hover:bg-blue-700");
    btn.classList.add("bg-red-600", "hover:bg-red-700");
    
    intervaloPlay = setInterval(() => {
      if (passoIndex < contraexemplo.length - 1) {
        passoIndex++;
        renderizarPasso();
      } else {
        clearInterval(intervaloPlay);
        intervaloPlay = null;
        btn.textContent = "‚ñ∂ Play";
        btn.classList.remove("bg-red-600");
        btn.classList.add("bg-blue-600");
      }
    }, vel);
  }
});

document.getElementById("verificarForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const submitButton = document.getElementById("submitButton");
  const originalText = "‚ñ∂Ô∏è Executar Verifica√ß√£o"; 
  submitButton.textContent = "‚è≥ Verificando... Aguarde.";
  submitButton.disabled = true;

  document.getElementById("resultadoContainer").classList.add("hidden");
  document.getElementById("contraExemploContainer").classList.add("hidden");
  document.getElementById("pytestContainer").classList.add("hidden");
  
  contraexemplo = [];
  passoIndex = 0;
  if (intervaloPlay) { clearInterval(intervaloPlay); intervaloPlay = null; }

  let codigo = document.getElementById("codigo").value.trim();
  const arquivoInput = document.getElementById("arquivo");
  
  const flags = [];
  if (document.getElementById("check-unwind").checked)
    flags.push("--unwind", document.getElementById("unwind-value").value);
  if (document.getElementById("check-context-bound").checked)
    flags.push("--context-bound", document.getElementById("context-value").value);
  
  document.querySelectorAll(".flag:checked").forEach(chk => flags.push(chk.value));

  if (arquivoInput.files.length > 0) {
    const arquivo = arquivoInput.files[0];
    codigo = await arquivo.text();
    document.getElementById("codigo").value = codigo;
  }

  if (!codigo) {
    alert("Por favor, insira um c√≥digo Python.");
    submitButton.textContent = originalText;
    submitButton.disabled = false;
    return;
  }

  try {
    const resposta = await fetch("/verificar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ codigo, flags })
    });

    const dados = await resposta.json();

    document.getElementById("comando").textContent = dados.comando || '$ esbmc ...';
    
    const statusEl = document.getElementById("interpretacao-status");
    const causaEl = document.getElementById("interpretacao-causa");
    const containerRes = document.getElementById("resultadoContainer");
    
    containerRes.classList.remove("hidden");
    document.getElementById("saidaBruta").textContent = dados.resultado_bruto;

    // USO DIRETO DOS CAMPOS ESTRUTURADOS
    if (dados.status_label) {
        statusEl.textContent = dados.status_label;
        statusEl.className = dados.status_class || "font-bold text-xl text-gray-800";
    } else {
        // Fallback
        statusEl.textContent = "Status desconhecido";
    }
    
    causaEl.textContent = dados.causa || "---";

    if (dados.contraexemplo && dados.contraexemplo.length > 0) {
      contraexemplo = dados.contraexemplo;
      passoIndex = 0;
      document.getElementById("contraExemploContainer").classList.remove("hidden");
      renderizarPasso();
    }

    if (dados.pytest_code) {
      document.getElementById("pytestContainer").classList.remove("hidden");
      document.getElementById("pytestCode").textContent = dados.pytest_code;
      document.getElementById("pytestResult").textContent = dados.pytest_result || "Executado.";
    }

  } catch (err) {
    alert("Erro de conex√£o: " + err);
  } finally {
    submitButton.textContent = originalText;
    submitButton.disabled = false;
  }
});

document.getElementById("toggleConsole").addEventListener("click", () => {
  document.getElementById("saidaBruta").classList.toggle("hidden");
});
</script>

</body>
</html>
